<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="../static/css/table.css" th:href="@{/css/table.css}"
	rel="stylesheet" />
<link th:href="@{/webjars/bootstrap/5.3.8/css/bootstrap.min.css}"
	rel="stylesheet" />
<script th:src="@{/webjars/bootstrap/5.3.8/js/bootstrap.bundle.min.js}"
	defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
	integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/3.16.0/billboard.min.js"
	integrity="sha512-HPcVm27xXkAoXgeg7jiK4Y9kIbXbwk2GiOxAzQ+EwdA3TNYtFAK0tYHoFS7KAK9zNRf89Oa5Qtnkw5gDpDR7Ww=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/3.16.0/billboard.min.css"
	integrity="sha512-njOj5MWC/MCTRlxjIsftPrGL3nuexguTsEN1qE8eLU6LZW1ZyccshJ1a2QneVxsyeDjbEqXl9TJNfCFUj8pDDg=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<title>SLM</title>
</head>
<body>
	<div th:insert="~{header :: header}">...</div>
	<div th:insert="~{header :: sleepheader}"></div>
	<h2>sleeptimes chart</h2>

	<div id="chart"></div>
	<div class="list" th:unless="${#lists.isEmpty(sleeptimes)}">

		<table class="table table-striped">
			<thead>
				<tr>
					<td>ID</td>
					<td>gotobed</td>
					<td>getup</td>
					<td>sleeptime</td>
				</tr>
			</thead>
			<tbody>
				<tr th:each="e : ${sleeptimes}">
					<td th:text="${e.id}"></td>
					<td th:text="${e.gotobed}"></td>
					<td th:text="${e.getup}"></td>
					<td th:text="${{e.sleeptime}}"></td>
				</tr>
			</tbody>
		</table>
	</div>
	<script>
	async function getData() {
		  let url = "http://localhost:8080/api/sleeptimes";
		  try {
		    let response = await fetch(url);
		    if (!response.ok) {
		      throw new Error(`Response status: ${response.status}`);
		    }
		    let result = await response.json();
		  } catch (error) {
		    console.error(error.message);
		  }
		}
	
	function getData2() {
		let url = "http://localhost:8080/api/sleeptimes";
		fetch(url).then((response) => {
			return response.json();
		}).then((data) => {
			console.log(data);
			return convertToBb(data);
		}).catch((error) => console.error('Error:',error))
	}
	
	function parseDuration(rawDuration) {
		let hourmins = rawDuration.slice(2, rawDuration.length - 1);
		if (rawDuration.includes("M")) {
			hourmins = rawDuration.slice(2, rawDuration.length - 1);
		} else {
			hourmins = rawDuration.slice(2, rawDuration.length);
		}
		let tmp = hourmins.split("H");
		let hours = Number(tmp[0]);
		let minutes = Number(tmp[1]);
		return hours + (minutes / 60);
	}
	
	function convertToBb(rawData) {
		let x = ["x"];
		let result = ["data1"];
		
		for (let e of rawData) {
			let ldt = e.gotobed.split("T")[0];
			let st = parseDuration(e.sleeptime);
			x.push(ldt);
			result.push(st);
		}

		chart.load({
			columns: [
				x, 
				result
			]
		});

		chart.axis.max(14);
		chart.axis.min(6);

		return result;
	}
	
	var bbData = getData2();
	
	var chart = bb.generate({
	    bindto: "#chart",
	    axis: {
	        x: {
	          type: "timeseries",
	          tick: {
	            format: "%Y-%m-%d"
	          }
	        }
	     },
	    data: {
	    	x: "x",
	        type: "line",
	        columns: [ [ ] ]
	    }
	});
	</script>
</body>
</html>
